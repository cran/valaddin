<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Eugene Ha" />

<meta name="date" content="2017-03-22" />

<title>Using valaddin</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Using valaddin</h1>
<h4 class="author"><em>Eugene Ha</em></h4>
<h4 class="date"><em>2017-03-22</em></h4>



<p><em>valaddin</em> is a lightweight R package that enables you to transform an existing function into a function with input validation checks. It does so without requiring you to modify the body of the function, in contrast to doing input validation using <code>stop</code> or <code>stopifnot</code>, and is therefore suitable for both programmatic and interactive use.</p>
<p>This document illustrates the use of valaddin, by example. For usage details, see the main documentation page, <code>?firmly</code>.</p>
<div id="use-cases" class="section level2">
<h2>Use cases</h2>
<p>The workhorse of valaddin is the function <code>firmly</code>, which applies input validation to a function, <em>in situ</em>. It can be used to:</p>
<div id="enforce-types-for-arguments" class="section level3">
<h3>Enforce types for arguments</h3>
<p>For example, to require that all arguments of the function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="cf">function</span>(x, h) (<span class="kw">sin</span>(x <span class="op">+</span><span class="st"> </span>h) <span class="op">-</span><span class="st"> </span><span class="kw">sin</span>(x)) <span class="op">/</span><span class="st"> </span>h</code></pre></div>
<p>are numerical, apply <code>firmly</code> with the check formula <code>~is.numeric</code><a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ff &lt;-<span class="st"> </span><span class="kw">firmly</span>(f, <span class="op">~</span>is.numeric)</code></pre></div>
<p><code>ff</code> behaves just like <code>f</code>, but with a constraint on the type of its arguments:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ff</span>(<span class="fl">0.0</span>, <span class="fl">0.1</span>)
<span class="co">#&gt; [1] 0.9983342</span>

<span class="kw">ff</span>(<span class="st">&quot;0.0&quot;</span>, <span class="fl">0.1</span>)
<span class="co">#&gt; Error: ff(x = &quot;0.0&quot;, h = 0.1)</span>
<span class="co">#&gt; FALSE: is.numeric(x)</span></code></pre></div>
</div>
<div id="enforce-constraints-on-argument-values" class="section level3">
<h3>Enforce constraints on argument values</h3>
<p>For example, use <code>firmly</code> to put a cap on potentially long-running computations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fib &lt;-<span class="st"> </span><span class="cf">function</span>(n) {
  <span class="cf">if</span> (n <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1</span>) <span class="kw">return</span>(1L)
  <span class="kw">Recall</span>(n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">Recall</span>(n <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)
}

capped_fib &lt;-<span class="st"> </span><span class="kw">firmly</span>(fib, <span class="kw">list</span>(<span class="st">&quot;n capped at 30&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">ceiling</span>(n)) <span class="op">~</span><span class="st"> </span>{. <span class="op">&lt;=</span><span class="st"> </span>30L})

<span class="kw">capped_fib</span>(<span class="dv">10</span>)
<span class="co">#&gt; [1] 89</span>
<span class="kw">capped_fib</span>(<span class="dv">50</span>)
<span class="co">#&gt; Error: capped_fib(n = 50)</span>
<span class="co">#&gt; n capped at 30</span></code></pre></div>
<p>The role of each part of the value-constraining formula is evident:</p>
<ul>
<li><p>The right-hand side <code>{. &lt;= 30L}</code> is the constraint itself, expressed as a condition on <code>.</code>, a placeholder argument.</p></li>
<li><p>The left-hand side <code>list(&quot;n capped at 30&quot; ~ ceiling(n))</code> specifies the expression for the placeholder, namely <code>ceiling(n)</code>, along with a message to produce if the constraint is violated.</p></li>
</ul>
</div>
<div id="warn-about-pitfalls" class="section level3">
<h3>Warn about pitfalls</h3>
<p>If the default behavior of a function is problematic, or unexpected, you can use <code>firmly</code> to warn you. Consider the function <code>as.POSIXct</code>, which creates a date-time object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">Sys.setenv</span>(<span class="dt">TZ =</span> <span class="st">&quot;CET&quot;</span>)
(d &lt;-<span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01 09:30:00&quot;</span>))
<span class="co">#&gt; [1] &quot;2017-01-01 09:30:00 CET&quot;</span></code></pre></div>
<p>The problem is that <code>d</code> is a potentially <em>ambiguous</em> object (with hidden state), because it’s not assigned a time zone, explicitly. If you compute the local hour of <code>d</code> using <code>as.POSIXlt</code>, you get an answer that interprets <code>d</code> according to your current time zone; another user—or you, in another country, in the future—may get a different result.</p>
<ul>
<li><p>If you’re in CET time zone:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.POSIXlt</span>(d, <span class="dt">tz =</span> <span class="st">&quot;EST&quot;</span>)<span class="op">$</span>hour
<span class="co">#&gt; [1] 3</span></code></pre></div></li>
<li><p>If you were to change to EST time zone and rerun the code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">Sys.setenv</span>(<span class="dt">TZ =</span> <span class="st">&quot;EST&quot;</span>)
d &lt;-<span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01 09:30:00&quot;</span>)
<span class="kw">as.POSIXlt</span>(d, <span class="dt">tz =</span> <span class="st">&quot;EST&quot;</span>)<span class="op">$</span>hour
<span class="co">#&gt; [1] 9</span></code></pre></div></li>
</ul>
<p>To warn yourself about this pitfall, you can modify <code>as.POSIXct</code> to complain when you’ve forgotten to specify a time zone:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">as.POSIXct &lt;-<span class="st"> </span><span class="kw">firmly</span>(as.POSIXct, <span class="dt">.warn_missing =</span> <span class="st">&quot;tz&quot;</span>)</code></pre></div>
<p>Now when you call <code>as.POSIXct</code>, you get a cautionary reminder:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01 09:30:00&quot;</span>)
<span class="co">#&gt; Warning: Argument(s) expected but not specified in call as.POSIXct(x =</span>
<span class="co">#&gt; &quot;2017-01-01 09:30:00&quot;): `tz`</span>
<span class="co">#&gt; [1] &quot;2017-01-01 09:30:00 CET&quot;</span>

<span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01 09:30:00&quot;</span>, <span class="dt">tz =</span> <span class="st">&quot;CET&quot;</span>)
<span class="co">#&gt; [1] &quot;2017-01-01 09:30:00 CET&quot;</span></code></pre></div>
<p><strong>NB</strong>: The missing-argument warning is implemented by wrapping functions. The underlying function <code>base::as.POSIXct</code> is called <em>unmodified</em>.</p>
<div id="use-loosely-to-access-the-original-function" class="section level4">
<h4>Use <code>loosely</code> to access the original function</h4>
<p>Though reassigning <code>as.POSIXct</code> may seem risky, it is not, for the behavior is unchanged (aside from the extra precaution), and the original <code>as.POSIXct</code> remains accessible:</p>
<ul>
<li>With a namespace prefix: <code>base::as.POSIXct</code></li>
<li>By applying <code>loosely</code> to strip input validation: <code>loosely(as.POSIXct)</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">loosely</span>(as.POSIXct)(<span class="st">&quot;2017-01-01 09:30:00&quot;</span>)
<span class="co">#&gt; [1] &quot;2017-01-01 09:30:00 CET&quot;</span>

<span class="kw">identical</span>(<span class="kw">loosely</span>(as.POSIXct), base<span class="op">::</span>as.POSIXct)
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
</div>
<div id="decline-handouts" class="section level3">
<h3>Decline handouts</h3>
<p>R tries to help you express your ideas as concisely as possible. Suppose you want to truncate negative values of a vector <code>w</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">w &lt;-<span class="st"> </span>{<span class="kw">set.seed</span>(<span class="dv">1</span>); <span class="kw">rnorm</span>(<span class="dv">5</span>)}

<span class="kw">ifelse</span>(w <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, w)
<span class="co">#&gt; [1] -0.6264538  0.0000000 -0.8356286  0.0000000  0.0000000</span></code></pre></div>
<p><code>ifelse</code> assumes (correctly) that you intend the <code>0</code> to be repeated 5 times, and does that for you, automatically.</p>
<p>Nonetheless, R’s good intentions have a darker side:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">6</span>)
pos &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span>
neg &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">6</span><span class="op">:-</span><span class="dv">1</span>

<span class="kw">ifelse</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, pos, neg)
<span class="co">#&gt; [1] 1 2 3 4 5 1</span></code></pre></div>
<p>This smells like a coding error. Instead of complaining that <code>pos</code> is too short, <code>ifelse</code> recycles it to line it up with <code>z</code>. The result is probably not what you wanted.</p>
<p>In this case, you don’t need a helping hand, but rather a firm one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">chk_length_type &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="st">&quot;'yes', 'no' differ in length&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">length</span>(yes) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(no),
  <span class="st">&quot;'yes', 'no' differ in type&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">typeof</span>(yes) <span class="op">==</span><span class="st"> </span><span class="kw">typeof</span>(no)
) <span class="op">~</span><span class="st"> </span>isTRUE

ifelse_f &lt;-<span class="st"> </span><span class="kw">firmly</span>(ifelse, chk_length_type)</code></pre></div>
<p><code>ifelse_f</code> is more pedantic than <code>ifelse</code>. But it also spares you the consequences of invalid inputs:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse_f</span>(w <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, w)
<span class="co">#&gt; Error: ifelse_f(test = w &gt; 0, yes = 0, no = w)</span>
<span class="co">#&gt; 'yes', 'no' differ in length</span>
<span class="kw">ifelse_f</span>(w <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(w)), w)
<span class="co">#&gt; [1] -0.6264538  0.0000000 -0.8356286  0.0000000  0.0000000</span>

<span class="kw">ifelse</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, pos, neg)
<span class="co">#&gt; [1] 1 2 3 4 5 1</span>
<span class="kw">ifelse_f</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, pos, neg)
<span class="co">#&gt; Error: ifelse_f(test = z &gt; 0, yes = pos, no = neg)</span>
<span class="co">#&gt; 'yes', 'no' differ in length</span>

<span class="kw">ifelse</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">as.character</span>(pos), neg)
<span class="co">#&gt; [1] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; &quot;5&quot; &quot;1&quot;</span>
<span class="kw">ifelse_f</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">as.character</span>(pos), neg)
<span class="co">#&gt; Error: ifelse_f(test = z &gt; 0, yes = as.character(pos), no = neg)</span>
<span class="co">#&gt; 1) 'yes', 'no' differ in length</span>
<span class="co">#&gt; 2) 'yes', 'no' differ in type</span></code></pre></div>
</div>
<div id="reduce-the-risks-of-a-lazy-evaluation-style" class="section level3">
<h3>Reduce the risks of a lazy evaluation-style</h3>
<p>When R make a function call, say, <code>f(a)</code>, the <em>value</em> of the argument <code>a</code> is not materialized in the body of <code>f</code> until it is actually needed. Usually, you can safely ignore this as a technicality of R’s evaluation model; but in some situations, it can be problematic if you’re not mindful of it.</p>
<p>Consider a bank that waives fees for students. A function to make deposits might look like this<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">deposit &lt;-<span class="st"> </span><span class="cf">function</span>(account, value) {
  <span class="cf">if</span> (<span class="kw">is_student</span>(account)) {
    account<span class="op">$</span>fees &lt;-<span class="st"> </span><span class="dv">0</span>
  }
  account<span class="op">$</span>balance &lt;-<span class="st"> </span>account<span class="op">$</span>balance <span class="op">+</span><span class="st"> </span>value
  account
}

is_student &lt;-<span class="st"> </span><span class="cf">function</span>(account) {
  <span class="cf">if</span> (<span class="kw">isTRUE</span>(account<span class="op">$</span>is_student)) <span class="ot">TRUE</span> <span class="cf">else</span> <span class="ot">FALSE</span>
}</code></pre></div>
<p>Suppose Bob is an account holder, currently not in school:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bobs_acct &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">balance =</span> <span class="dv">10</span>, <span class="dt">fees =</span> <span class="dv">3</span>, <span class="dt">is_student =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>If Bob were to deposit an amount to cover an future fee payment, his account balance would be updated to:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">deposit</span>(bobs_acct, bobs_acct<span class="op">$</span>fees)<span class="op">$</span>balance
<span class="co">#&gt; [1] 13</span></code></pre></div>
<p>Bob goes back to school and informs the bank, so that his fees will be waived:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bobs_acct<span class="op">$</span>is_student &lt;-<span class="st"> </span><span class="ot">TRUE</span></code></pre></div>
<p>But now suppose that, somewhere in the bowels of the bank’s software, the type of Bob’s account object is converted from a list to an environment:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bobs_acct &lt;-<span class="st"> </span><span class="kw">list2env</span>(bobs_acct)</code></pre></div>
<p>If Bob were to deposit an amount to cover an future fee payment, his account balance would now be updated to:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">deposit</span>(bobs_acct, bobs_acct<span class="op">$</span>fees)<span class="op">$</span>balance
<span class="co">#&gt; [1] 10</span></code></pre></div>
<p>Becoming a student has cost Bob money. What happened to the amount deposited?</p>
<p>The culprit is lazy evaluation and the modify-in-place semantics of environments. In the call <code>deposit(account = bobs_acct, value = bobs_acct$fee)</code>, the value of the argument <code>value</code> is only set when it’s used, which comes after the object <code>fee</code> in the environment <code>bobs_acct</code> has already been zeroed out.</p>
<p>To minimize such risks, forbid <code>account</code> from being an environment:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">err_msg &lt;-<span class="st"> &quot;`acccount` should not be an environment&quot;</span>
deposit &lt;-<span class="st"> </span><span class="kw">firmly</span>(deposit, <span class="kw">list</span>(err_msg <span class="op">~</span><span class="st"> </span>account) <span class="op">~</span><span class="st"> </span><span class="kw">Negate</span>(is.environment))</code></pre></div>
<p>This makes Bob a happy customer, and reduces the bank’s liability:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bobs_acct &lt;-<span class="st"> </span><span class="kw">list2env</span>(<span class="kw">list</span>(<span class="dt">balance =</span> <span class="dv">10</span>, <span class="dt">fees =</span> <span class="dv">3</span>, <span class="dt">is_student =</span> <span class="ot">TRUE</span>))

<span class="kw">deposit</span>(bobs_acct, bobs_acct<span class="op">$</span>fees)<span class="op">$</span>balance
<span class="co">#&gt; Error: deposit(account = bobs_acct, value = bobs_acct$fees)</span>
<span class="co">#&gt; `acccount` should not be an environment</span>

<span class="kw">deposit</span>(<span class="kw">as.list</span>(bobs_acct), bobs_acct<span class="op">$</span>fees)<span class="op">$</span>balance
<span class="co">#&gt; [1] 13</span></code></pre></div>
</div>
<div id="prevent-self-inflicted-wounds" class="section level3">
<h3>Prevent self-inflicted wounds</h3>
<p>You don’t mean to shoot yourself, but sometimes it happens, nonetheless:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> &quot;An expensive object&quot;</span>
<span class="kw">save</span>(x, <span class="dt">file =</span> <span class="st">&quot;my-precious.rda&quot;</span>)

x &lt;-<span class="st"> &quot;Oops! A bug or lapse has tarnished your expensive object&quot;</span>

<span class="co"># Many computations later, you again save x, oblivious to the accident ...</span>
<span class="kw">save</span>(x, <span class="dt">file =</span> <span class="st">&quot;my-precious.rda&quot;</span>)</code></pre></div>
<p><code>firmly</code> can safeguard you from such mishaps: implement a safety procedure</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Argument `gear` is a list with components:</span>
<span class="co"># fun: Function name</span>
<span class="co"># ns : Namespace of `fun`</span>
<span class="co"># chk: Formula that specify input checks</span>

hardhat &lt;-<span class="st"> </span><span class="cf">function</span>(gear, <span class="dt">env =</span> .GlobalEnv) {
  <span class="cf">for</span> (. <span class="cf">in</span> gear) {
    safe_fun &lt;-<span class="st"> </span><span class="kw">firmly</span>(<span class="kw">getFromNamespace</span>(.<span class="op">$</span>fun, .<span class="op">$</span>ns), .<span class="op">$</span>chk)
    <span class="kw">assign</span>(.<span class="op">$</span>fun, safe_fun, <span class="dt">envir =</span> env)
  }
}</code></pre></div>
<p>gather your safety gear</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">protection &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="kw">list</span>(
    <span class="dt">fun =</span> <span class="st">&quot;save&quot;</span>,
    <span class="dt">ns  =</span> <span class="st">&quot;base&quot;</span>,
    <span class="dt">chk =</span> <span class="kw">list</span>(<span class="st">&quot;Won't overwrite `file`&quot;</span> <span class="op">~</span><span class="st"> </span>file) <span class="op">~</span><span class="st"> </span><span class="kw">Negate</span>(file.exists)
  ),
  <span class="kw">list</span>(
    <span class="dt">fun =</span> <span class="st">&quot;load&quot;</span>,
    <span class="dt">ns  =</span> <span class="st">&quot;base&quot;</span>,
    <span class="dt">chk =</span> <span class="kw">list</span>(<span class="st">&quot;Won't load objects into current environment&quot;</span> <span class="op">~</span><span class="st"> </span>envir) <span class="op">~</span>
<span class="st">      </span>{<span class="op">!</span><span class="kw">identical</span>(., <span class="kw">parent.frame</span>(<span class="dv">2</span>))}
  )
)</code></pre></div>
<p>then put it on</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hardhat</span>(protection)</code></pre></div>
<p>Now <code>save</code> and <code>load</code> engage safety features that prevent you from inadvertently destroying your data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> &quot;An expensive object&quot;</span>
<span class="kw">save</span>(x, <span class="dt">file =</span> <span class="st">&quot;my-precious.rda&quot;</span>)

x &lt;-<span class="st"> &quot;Oops! A bug or lapse has tarnished your expensive object&quot;</span>
<span class="co">#&gt; Error: save(x, file = &quot;my-precious.rda&quot;)</span>
<span class="co">#&gt; Won't overwrite `file`</span>

<span class="kw">save</span>(x, <span class="dt">file =</span> <span class="st">&quot;my-precious.rda&quot;</span>)

<span class="co"># Inspecting x, you notice it's changed, so you try to retrieve the original ...</span>
x
<span class="co">#&gt; [1] &quot;Oops! A bug or lapse has tarnished your expensive object&quot;</span>
<span class="kw">load</span>(<span class="st">&quot;my-precious.rda&quot;</span>)
<span class="co">#&gt; Error: load(file = &quot;my-precious.rda&quot;)</span>
<span class="co">#&gt; Won't load objects into current environment</span>

<span class="co"># Keep calm and carry on</span>
<span class="kw">loosely</span>(load)(<span class="st">&quot;my-precious.rda&quot;</span>)

x
<span class="co">#&gt; [1] &quot;An expensive object&quot;</span></code></pre></div>
<p><strong>NB</strong>: Input validation is implemented by wrapping functions; thus, if the arguments are valid, the underlying functions <code>base::save</code>, <code>base::load</code> are called <em>unmodified</em>.</p>
</div>
</div>
<div id="toolbox-of-input-checkers" class="section level2">
<h2>Toolbox of input checkers</h2>
<p><em>valaddin</em> provides a collection of over 50 pre-made input checkers to facilitate typical kinds of argument checks. These checkers are prefixed by <code>vld_</code>, for convenient browsing and look-up in editors and IDE’s that support name completion.</p>
<p>For example, to create a type-checked version of the function <code>upper.tri</code>, which returns an upper-triangular logical matrix, apply the checkers <code>vld_matrix</code>, <code>vld_boolean</code> (here “boolean” is shorthand for “logical vector of length 1”):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">upper_tri &lt;-<span class="st"> </span><span class="kw">firmly</span>(upper.tri, <span class="kw">vld_matrix</span>(<span class="op">~</span>x), <span class="kw">vld_boolean</span>(<span class="op">~</span>diag))

<span class="co"># upper.tri assumes you mean a vector to be a column matrix</span>
<span class="kw">upper.tri</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)
<span class="co">#&gt;       [,1]</span>
<span class="co">#&gt; [1,] FALSE</span>
<span class="co">#&gt; [2,] FALSE</span>

<span class="kw">upper_tri</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)
<span class="co">#&gt; Error: upper_tri(x = 1:2)</span>
<span class="co">#&gt; Not matrix: x</span>

<span class="co"># But say you actually meant (1, 2) to be a diagonal matrix</span>
<span class="kw">upper_tri</span>(<span class="kw">diag</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))
<span class="co">#&gt;       [,1]  [,2]</span>
<span class="co">#&gt; [1,] FALSE  TRUE</span>
<span class="co">#&gt; [2,] FALSE FALSE</span>

<span class="kw">upper_tri</span>(<span class="kw">diag</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>), <span class="dt">diag =</span> <span class="st">&quot;true&quot;</span>)
<span class="co">#&gt; Error: upper_tri(x = diag(1:2), diag = &quot;true&quot;)</span>
<span class="co">#&gt; Not boolean: diag</span>

<span class="kw">upper_tri</span>(<span class="kw">diag</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>), <span class="ot">TRUE</span>)
<span class="co">#&gt;       [,1] [,2]</span>
<span class="co">#&gt; [1,]  TRUE TRUE</span>
<span class="co">#&gt; [2,] FALSE TRUE</span></code></pre></div>
<div id="check-anything-with-vld_true" class="section level3">
<h3>Check anything with <code>vld_true</code></h3>
<p>Any input validation can be expressed as an assertion that “such and such must be true”; to apply it as such, use <code>vld_true</code> (or its complement, <code>vld_false</code>).</p>
<p>For example, the above hardening of <code>ifelse</code> can be redone as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">chk_length_type &lt;-<span class="st"> </span><span class="kw">vld_true</span>(
  <span class="st">&quot;'yes', 'no' differ in length&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">length</span>(yes) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(no),
  <span class="st">&quot;'yes', 'no' differ in type&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">typeof</span>(yes) <span class="op">==</span><span class="st"> </span><span class="kw">typeof</span>(no)
)
ifelse_f &lt;-<span class="st"> </span><span class="kw">firmly</span>(ifelse, chk_length_type)

z &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">6</span>)
pos &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span>
neg &lt;-<span class="st"> </span><span class="op">-</span><span class="dv">6</span><span class="op">:-</span><span class="dv">1</span>

<span class="kw">ifelse_f</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">as.character</span>(pos), neg)
<span class="co">#&gt; Error: ifelse_f(test = z &gt; 0, yes = as.character(pos), no = neg)</span>
<span class="co">#&gt; 1) 'yes', 'no' differ in length</span>
<span class="co">#&gt; 2) 'yes', 'no' differ in type</span>
<span class="kw">ifelse_f</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">c</span>(pos, <span class="dv">6</span>), neg)
<span class="co">#&gt; Error: ifelse_f(test = z &gt; 0, yes = c(pos, 6), no = neg)</span>
<span class="co">#&gt; 'yes', 'no' differ in type</span>
<span class="kw">ifelse_f</span>(z <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="kw">c</span>(pos, 6L), neg)
<span class="co">#&gt; [1] 1 2 3 4 5 6</span></code></pre></div>
</div>
<div id="make-your-own-input-checker-with-localize" class="section level3">
<h3>Make your own input checker with <code>localize</code></h3>
<p>A check formula such as <code>~ is.numeric</code> (or <code>&quot;Not number&quot; ~ is.numeric</code>, if you want a custom error message) imposes its condition “globally”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">difference &lt;-<span class="st"> </span><span class="kw">firmly</span>(<span class="cf">function</span>(x, y) x <span class="op">-</span><span class="st"> </span>y, <span class="op">~</span><span class="st"> </span>is.numeric)

<span class="kw">difference</span>(<span class="dv">3</span>, <span class="dv">1</span>)
<span class="co">#&gt; [1] 2</span>
<span class="kw">difference</span>(<span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01&quot;</span>, <span class="st">&quot;UTC&quot;</span>), <span class="kw">as.POSIXct</span>(<span class="st">&quot;2016-01-01&quot;</span>, <span class="st">&quot;UTC&quot;</span>))
<span class="co">#&gt; Error: difference(x = as.POSIXct(&quot;2017-01-01&quot;, &quot;UTC&quot;), y = as.POSIXct(&quot;2016-01-01&quot;,&quot;UTC&quot;))</span>
<span class="co">#&gt; 1) FALSE: is.numeric(x)</span>
<span class="co">#&gt; 2) FALSE: is.numeric(y)</span></code></pre></div>
<p>With <code>localize</code>, you can concentrate a globally applied check formula to specific expressions. The result is a <em>reusable</em> custom checker:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">chk_numeric &lt;-<span class="st"> </span><span class="kw">localize</span>(<span class="st">&quot;Not numeric&quot;</span> <span class="op">~</span><span class="st"> </span>is.numeric)
secant &lt;-<span class="st"> </span><span class="kw">firmly</span>(<span class="cf">function</span>(f, x, h) (<span class="kw">f</span>(x <span class="op">+</span><span class="st"> </span>h) <span class="op">-</span><span class="st"> </span><span class="kw">f</span>(x)) <span class="op">/</span><span class="st"> </span>h, <span class="kw">chk_numeric</span>(<span class="op">~</span>x, <span class="op">~</span>h))

<span class="kw">secant</span>(sin, <span class="dv">0</span>, .<span class="dv">1</span>)
<span class="co">#&gt; [1] 0.9983342</span>
<span class="kw">secant</span>(sin, <span class="st">&quot;0&quot;</span>, .<span class="dv">1</span>)
<span class="co">#&gt; Error: secant(f = sin, x = &quot;0&quot;, h = 0.1)</span>
<span class="co">#&gt; Not numeric: x</span></code></pre></div>
<p>(In fact, <code>chk_numeric</code> is equivalent to the pre-built checker <code>vld_numeric</code>.)</p>
<p>Conversely, apply <code>globalize</code> to impose your localized checker globally:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">difference &lt;-<span class="st"> </span><span class="kw">firmly</span>(<span class="cf">function</span>(x, y) x <span class="op">-</span><span class="st"> </span>y, <span class="kw">globalize</span>(chk_numeric))

<span class="kw">difference</span>(<span class="dv">3</span>, <span class="dv">1</span>)
<span class="co">#&gt; [1] 2</span>
<span class="kw">difference</span>(<span class="kw">as.POSIXct</span>(<span class="st">&quot;2017-01-01&quot;</span>, <span class="st">&quot;UTC&quot;</span>), <span class="kw">as.POSIXct</span>(<span class="st">&quot;2016-01-01&quot;</span>, <span class="st">&quot;UTC&quot;</span>))
<span class="co">#&gt; Error: difference(x = as.POSIXct(&quot;2017-01-01&quot;, &quot;UTC&quot;), y = as.POSIXct(&quot;2016-01-01&quot;,&quot;UTC&quot;))</span>
<span class="co">#&gt; 1) Not numeric: `x`</span>
<span class="co">#&gt; 2) Not numeric: `y`</span></code></pre></div>
</div>
</div>
<div id="related-packages" class="section level2">
<h2>Related packages</h2>
<div id="packages-that-enhance-valaddin" class="section level3">
<h3>Packages that enhance valaddin</h3>
<ul>
<li><p><a href="https://bitbucket.org/richierocks/assertive">assertive</a>, <a href="https://github.com/hadley/assertthat">assertthat</a>, and <a href="https://github.com/mllg/checkmate">checkmate</a> provide extensive collections of predicate functions that you can use in conjunction with <code>firmly</code> and <code>localize</code>.</p></li>
<li><p><a href="https://github.com/smbache/ensurer">ensurer</a> and <a href="https://github.com/ropensci/assertr">assertr</a> provide a means of validating function <em>values</em>; this is complementary to functional input validation, which is what valaddin provides. Additionally, ensurer provides an experimental replacement for <code>function</code> that builds functions with type-validated arguments.</p></li>
</ul>
</div>
<div id="other-approaches-to-input-validation" class="section level3">
<h3>Other approaches to input validation</h3>
<ul>
<li><p><a href="https://github.com/gaborcsardi/argufy">argufy</a> takes a different approach to input validation, using <a href="https://github.com/klutometis/roxygen">roxygen</a> comments to specify checks.</p></li>
<li><p><a href="https://github.com/smbache/ensurer">ensurer</a> provides an experimental replacement for <code>function</code> that builds functions with type-validated arguments.</p></li>
<li><p><a href="https://github.com/jimhester/typeCheck">typeCheck</a>, together with <a href="https://github.com/jimhester/types">Types for R</a>, enable the creation of functions with type-validated arguments by means of special type annotations. This approach is orthogonal to that of valaddin: whereas valaddin specifies input checks as <em>predicate functions with scope</em> (predicates are primary), typeCheck specifies input checks as <em>arguments with type</em> (arguments are primary).</p></li>
</ul>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The inspiration to use <code>~</code> as a quoting operator came from the vignette <a href="https://cran.r-project.org/package=lazyeval/vignettes/lazyeval.html">Non-standard evaluation</a>, by Hadley Wickham.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Adapted from an example in Section 6.3 of Chambers, <em>Extending R</em>, CRC Press, 2016. For the sake of the example, ignore the fact that logic to handle fees does not belong in a function for deposits!<a href="#fnref2">↩</a></p></li>
</ol>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
